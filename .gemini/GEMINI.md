# QuantPyLab 项目指南 (系统指令)
## 0.必须严格遵守开发核心原则
必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则

必须严格遵守开发核心原则
## 1. 项目定位
`QuantPyLab` 是一个基于 Python 的量化交易实验室，旨在实现从数据获取、存储、分析到回测的全流程闭环。

## 2. 文档管理体系
本项目采用“双区”文档管理模式：
- **docs/ (正式文档区)**：存放项目已稳定的技术架构、数据规范等。
    - `data_catalog.md`: 数据字典入口，链接至 `catalog/` 下的各模块详细说明。
    - `catalog/`: 存放各业务模块的字段详细定义（如 `market_data.md`, `financial_statements.md` 等）。
- **workspace/ (工作区)**：存放正在开发中的 Feature 设计文档、调研笔记等。
- **绘图规范**：所有文档中的架构图、流程图、序列图必须使用 **PlantUML** 语法编写。
- **维护规则**：
    - 新 Feature 开始前，应在 `workspace/` 创建设计文档。
    - Feature 完成并经过验证后，相关设计说明必须同步并融合到 `docs/` 中的正式文档。

## 3. 开发核心原则
1. **文档先行 (Docs-First Discovery)**：
    - 在新对话开始或接到新需求时，**禁止直接搜索代码**。
    - **必须首先阅读 `docs/` 目录下的所有文档**，以理解项目的整体架构、设计哲学和现有规范。
    - 只有在完全理解文档设定的“真相源”后，方可进入 `workspace/` 进行设计。
2. **提案与确认机制 (Proposal & Confirmation Protocol)**：
    - **严禁抢跑**：在接到修改指令（无论是代码还是文档）时，**禁止**直接执行写入类工具（如 `write_file`, `replace`）。
    - **分级提案**：
        - **复杂变更**（涉及架构调整、Schema 变更、多模块协同）：必须先在 `workspace/` 编写或更新设计文档。
        - **常规变更**（单文件逻辑、Bug 修复、文档调整）：可直接在对话中以文字形式提交 **方案概述** 或 **Diff 预览**。
    - **确认锁 (Confirmation Lock)**：提交方案后，必须显式询问：“是否批准实施？”。**只有在获得用户明确回复（如“批准”、“可以”）后**，方可解锁工具进行修改。
3. **数据怀疑论 (Data Skepticism)**：
    - **严禁假设**：绝不假设两个数据源的单位、格式或含义一致（例如：不要默认都是“元”或“%”）。
    - **实测采样**：在进行数据定义或入库前，必须通过脚本抓取**真实非空样例**（Sample Values）进行验证。用真实数据反推逻辑，而不是用逻辑去套数据。
4. **全量分析 (Exhaustive Analysis)**：
    - 在进行接口调研或数据源对比时，默认提供**全量差异矩阵**。
    - **禁止擅自“精选”**：除非用户明确要求“只看核心指标”，否则不要隐藏任何字段或细节，以免遗漏关键异构数据。
5. **分析优先**：利用 DuckDB 列式特性进行 SQL 层筛选，减少内存开销。
6. **读写分离**：统一通过 `storage/manager.py` 接口操作数据。
7. **探索与验证**：在正式设计前，应在 `workspace/` 编写测试 Demo。所有探测、demo、测试代码必须写在 workspace 目录下。
8. **运行规范**：本项目统一使用 `uv` 进行环境管理和任务运行，执行脚本时应使用 `uv run` 而非直接调用 `python`。
9. **具体技术细节请参阅**：`docs/architecture.md`。
10. **项目操作指南请参阅**：`docs/usage.md`。

## 4. 项目进度
- [x] **基础架构搭建**：完成 `uv` 环境配置，实现 `config` 配置中心、`utils` 日志工具以及支持 SQLite/DuckDB 双引擎的 `storage` 数据库管理模块。
- [x] **文档体系构建**：建立 `docs/` 与 `workspace/` 双区模式，并完成初步架构文档迁移。
- [x] **股票列表同步 (Phase 1)**：实现 A 股基础代码与名称同步至 SQLite，确立了严格的 Schema 写入规范。
- [x] **股票元数据补全 (Phase 1.5)**：实现基于东财原生接口的高速行业同步及多源混合（雪球/东财）的地域与上市日期补全，支持通过 `--industry` 和 `--list-info` 进行颗粒度控制。
- [x] **财务数据同步引擎**：实现基于“披露日历驱动”的智能增量同步，支持 A 股三大财务报表的采集。
- [x] **财务指标库构建**：实现基于东财源的 140+ 财务指标同步，支持动态 Schema 扩展与中文列名映射。
- [x] **存储架构升级 (Data Lake)**：完成从单进程 DuckDB 到 **Parquet Data Lake** 的迁移，实现存算分离与全并发读写。
- [x] **财务 TTM 计算引擎**：实现基于原始财报的滚动十二个月（TTM）指标自主计算，支持净利润、收入及现金流 TTM。
- [x] **日线 K 线同步引擎**：实现增量采集逻辑并以 Parquet 格式存储，支持自动计算复权因子与股本变动。
- [x] **财务/分析层建设**：基于 DuckDB 建立动态估值视图 (v_daily_valuation)，支持 PE/PB/PS/PCF 等指标的无穿越回测。

## 5. 后续计划
- [ ] 优化财务指标同步功能，实现披露驱动的增量同步。
- [ ] 实现日线数据同步引擎。

## 6. 文档维护规范
- **维护流程**：修改任何文档（含本文件、`docs/` 等）前，同样遵循上述 **“提案-确认-实施”** 原则。对此类修改，无需编写专门的设计文档，但必须在对话中明确说明修改意图或内容，并获得批准后方可执行。
- **契约一致性**：若开发过程中发现实际情况与设计文档冲突，**必须先修改文档并获得确认**，严禁在文档未更新的情况下擅自变更实现逻辑。
- **功能完备性 (Definition of Done)**：在宣布任务完成前，**必须显式执行以下清单**，确保没有遗留碎片：
    1. **归档 (Archive)**：将 `workspace/` 中的有效设计文档、架构图、调研报告正式移至 `docs/`。
    2. **清理 (Cleanup)**：删除 `workspace/` 中为了开发该 Feature 而创建的临时探测脚本、测试 Demo、日志文件。
    3. **文档同步 (Doc Sync)**：更新 `README.md` 和 `docs/` 下的所有受影响文档（如 `usage.md`, `architecture.md`, `data_schema.md`），确保文档始终反映最新的代码现状。
    4. **进度更新 (Progress Updates)**：在 `GEMINI.md` 的“4. 项目进度”中记录完成情况，并同步更新“5. 后续计划”。
- **刷新机制**：修改本文件后，提醒执行 `/memory refresh`。

## 7. 技术方案编写规范 (RFC Guidance)
当需要针对复杂需求编写技术方案（RFC）时，应遵循以下 **指导原则**，而非死板的模版。其核心目的是：**在评审场景下，让不熟悉细节的同行能快速理解设计意图并评估风险。**

### 核心设计原则
1.  **目标导向 (Why First)**：明确方案是为了解决什么痛点或实现什么价值。
2.  **视觉优先 (Visual Thinking)**：复杂的逻辑流、数据流、状态机，**必须** 优先考虑使用 **PlantUML** 图表表达。
3.  **对比决策 (Trade-offs)**：方案不只有“怎么做”，还要说明“为什么不选另一种做法”，展示对成本、复杂度和性能的权衡。
4.  **按需调整 (Adaptability)**：方案篇幅应与复杂度匹配。小重构重在“改动点对比”，大架构重在“模块职责与交互”。

### 建议包含的要素 (按需选取)
-   **背景与挑战**：简述现状及必须要改的原因。
-   **方案概览**：核心思路的“定性”描述。
-   **技术设计**：
    -   *架构图/流程图*（建议使用 PlantUML）。
    -   *关键机制*：如并发控制、容错处理、数据一致性保障。
    -   *代码片段/伪代码*：展示核心逻辑或关键 API 设计。
-   **数据变更**：涉及到的物理存储结构（目录、Schema）的变化。
-   **风险与约束**：潜在的性能隐患、兼容性问题或未解决的盲点。
-   **演进计划**：如何平滑迁移，是否需要双写或灰度。


