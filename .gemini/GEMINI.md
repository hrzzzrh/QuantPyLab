# QuantPyLab 项目指南 (系统指令)

## 1. 项目定位
`QuantPyLab` 是一个基于 Python 的量化交易实验室，旨在实现从数据获取、存储、分析到回测的全流程闭环。

## 2. 文档管理体系
本项目采用“双区”文档管理模式：
- **docs/ (正式文档区)**：存放项目已稳定的技术架构、数据规范、API 指南等。它是项目的“真相源”。
- **workspace/ (工作区)**：存放正在开发中的 Feature 设计文档、调研笔记等。
- **绘图规范**：所有文档中的架构图、流程图、序列图必须使用 **PlantUML** 语法编写。
- **维护规则**：
    - 新 Feature 开始前，应在 `workspace/` 创建设计文档。
    - Feature 完成并经过验证后，相关设计说明必须同步并融合到 `docs/` 中的正式文档。

## 3. 开发核心原则
1. **文档先行 (Docs-First Discovery)**：
    - 在新对话开始或接到新需求时，**禁止直接搜索代码**。
    - **必须首先阅读 `docs/` 目录下的所有文档**，以理解项目的整体架构、设计哲学和现有规范。
    - 只有在完全理解文档设定的“真相源”后，方可进入 `workspace/` 进行设计。
2. **文档驱动与确认**：
    - 修改或增加核心逻辑前，先在 `workspace/` 更新设计思路。
    - **严格的“设计-确认-实施”流程**：提交设计文档后，必须**显式询问用户**：“是否批准开始实施？”。只有在获得明确许可后，方可编写功能代码。
2. **数据怀疑论 (Data Skepticism)**：
    - **严禁假设**：绝不假设两个数据源的单位、格式或含义一致（例如：不要默认都是“元”或“%”）。
    - **实测采样**：在进行数据定义或入库前，必须通过脚本抓取**真实非空样例**（Sample Values）进行验证。用真实数据反推逻辑，而不是用逻辑去套数据。
3. **全量分析 (Exhaustive Analysis)**：
    - 在进行接口调研或数据源对比时，默认提供**全量差异矩阵**。
    - **禁止擅自“精选”**：除非用户明确要求“只看核心指标”，否则不要隐藏任何字段或细节，以免遗漏关键异构数据。
4. **分析优先**：利用 DuckDB 列式特性进行 SQL 层筛选，减少内存开销。
5. **读写分离**：统一通过 `storage/manager.py` 接口操作数据。
6. **探索与验证**：在正式设计前，应在 `workspace/` 编写测试 Demo。所有探测、demo、测试代码必须写在 workspace 目录下。
5. **运行规范**：本项目统一使用 `uv` 进行环境管理和任务运行，执行脚本时应使用 `uv run` 而非直接调用 `python`。
6. **具体技术细节请参阅**：`docs/architecture.md`。
7. **项目操作指南请参阅**：`docs/usage.md`。

## 4. 项目进度
- [x] **基础架构搭建**：完成 `uv` 环境配置，实现 `config` 配置中心、`utils` 日志工具以及支持 SQLite/DuckDB 双引擎的 `storage` 数据库管理模块。
- [x] **文档体系构建**：建立 `docs/` 与 `workspace/` 双区模式，并完成初步架构文档迁移。
- [x] **股票列表同步 (Phase 1)**：实现 A 股基础代码与名称同步至 SQLite，确立了严格的 Schema 写入规范。
- [x] **股票元数据补全 (Phase 1.5)**：实现基于东财原生接口的高速行业同步（1分钟级）及多源混合（雪球/东财）的地域与上市日期补全。
- [x] **财务数据同步引擎**：实现基于“披露日历驱动”的智能增量同步，支持 A 股三大财务报表的采集并存储至 DuckDB。
- [x] **财务指标库构建**：实现基于东财源的 140+ 财务指标同步，支持动态 Schema 扩展与中文列名映射。
- [ ] **日线 K 线同步引擎**：实现增量采集逻辑并以 Parquet 格式存储。
- [ ] **财务/分析层建设**：基于 DuckDB 建立财务报表分析视图。

## 5. 后续计划
- [ ] 优化财务指标同步功能，实现披露驱动的增量同步。
- [ ] 实现日线数据同步引擎。

## 6. 文档维护规范
- **动态更新与维护**：若我认为有必要修改 `GEMINI.md`、`docs/` 或 `workspace/`，我会主动提示并确认。
- **契约一致性**：若开发过程中发现实际情况与设计文档冲突，**必须先修改文档并获得确认**，严禁在文档未更新的情况下擅自变更实现逻辑。
- **功能完备性 (Definition of Done)**：每当完成重大功能或新增运行指令时，**必须同步更新 `README.md` 和 `docs/`的所有文档**。确保文档始终反映最新的系统情况。
- **进度与说明同步**：实时维护“4. 项目进度”、“5. 后续计划”。任务完成后需提请用户确认并执行文档同步。
- **刷新机制**：修改本文件后，提醒执行 `/memory refresh`。

## 7. Git 协作规范
- **即时同步**：本项目已关联远程仓库。每当执行完 `git commit` 操作后，必须紧接着执行 `git push`，确保本地工作进度与远程仓库实时同步。
